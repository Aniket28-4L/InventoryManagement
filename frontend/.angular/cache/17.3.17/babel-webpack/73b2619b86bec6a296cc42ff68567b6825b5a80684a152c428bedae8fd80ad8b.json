{"ast":null,"code":"import _asyncToGenerator from \"A:/FinalIM/InventoryManagement/frontend/node_modules/@angular-devkit/build-angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nimport { Component } from '@angular/core';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { ToastrService } from 'ngx-toastr';\nimport { ProductsService } from '../../../core/services/products.service';\nimport { WarehouseService } from '../../../core/services/warehouse.service';\nimport { AuthService } from '../../../core/services/auth.service';\nimport { ApiService } from '../../../core/services/api.service';\nimport { environment } from '../../../../environments/environment';\nlet ProductDetailComponent = class ProductDetailComponent {\n  constructor(route, router, productsService, warehouseService, authService, api, toastr) {\n    this.route = route;\n    this.router = router;\n    this.productsService = productsService;\n    this.warehouseService = warehouseService;\n    this.authService = authService;\n    this.api = api;\n    this.toastr = toastr;\n    this.product = null;\n    this.stock = [];\n    this.warehouses = [];\n    this.loading = true;\n    this.stockLoading = false;\n    this.showAddStockModal = false;\n    this.showAdjustStockModal = false;\n    this.selectedStock = null;\n    this.stockForm = {\n      warehouseId: '',\n      qty: '',\n      locationId: ''\n    };\n    this.generatingPdf = false;\n  }\n  ngOnInit() {\n    const id = this.route.snapshot.paramMap.get('id');\n    if (id) {\n      this.loadProduct(id);\n    }\n  }\n  loadProduct(id) {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      const token = _this.authService.token;\n      if (!token) return;\n      try {\n        _this.loading = true;\n        const [productRes, stockRes, warehousesRes] = yield Promise.all([_this.productsService.get(id).toPromise(), _this.productsService.stock(id).toPromise().catch(() => []), _this.warehouseService.list({\n          page: 1,\n          limit: 1000\n        }).toPromise()]);\n        _this.product = productRes;\n        _this.stock = stockRes || [];\n        _this.warehouses = warehousesRes?.warehouses || [];\n        // Auto-generate PDF if it doesn't exist (happens in backend, but ensure it's triggered)\n        // The backend getProduct endpoint already handles this\n      } catch (error) {\n        _this.toastr.error(error?.message || 'Failed to load product');\n      } finally {\n        _this.loading = false;\n      }\n    })();\n  }\n  getQrCodeValue() {\n    if (!this.product) return '';\n    // If PDF URL exists, use it for QR code, otherwise use barcode\n    if (this.product.pdfUrl) {\n      const baseUrl = window.location.origin;\n      return this.product.pdfUrl.startsWith('http') ? this.product.pdfUrl : `${baseUrl}${this.product.pdfUrl}`;\n    }\n    return this.product.barcode || this.product.sku || '';\n  }\n  refreshStock() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      const id = _this2.route.snapshot.paramMap.get('id');\n      if (!id) return;\n      const token = _this2.authService.token;\n      if (!token) return;\n      try {\n        _this2.stockLoading = true;\n        const stockRes = yield _this2.productsService.stock(id).toPromise();\n        _this2.stock = stockRes || [];\n      } catch (error) {\n        console.error('Failed to refresh stock:', error);\n      } finally {\n        _this2.stockLoading = false;\n      }\n    })();\n  }\n  handleAddStock(e) {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      e.preventDefault();\n      const id = _this3.route.snapshot.paramMap.get('id');\n      if (!id || !_this3.stockForm.warehouseId || !_this3.stockForm.qty) {\n        _this3.toastr.error('Please fill in warehouse and quantity');\n        return;\n      }\n      const token = _this3.authService.token;\n      if (!token) return;\n      try {\n        yield _this3.warehouseService.addStock({\n          productId: id,\n          warehouseId: _this3.stockForm.warehouseId,\n          qty: parseFloat(_this3.stockForm.qty),\n          locationId: _this3.stockForm.locationId || null\n        }).toPromise();\n        _this3.toastr.success('Stock added successfully');\n        _this3.showAddStockModal = false;\n        _this3.stockForm = {\n          warehouseId: '',\n          qty: '',\n          locationId: ''\n        };\n        yield _this3.refreshStock();\n      } catch (error) {\n        _this3.toastr.error(error?.message || 'Failed to add stock');\n      }\n    })();\n  }\n  handleAdjustStock(e) {\n    var _this4 = this;\n    return _asyncToGenerator(function* () {\n      e.preventDefault();\n      const id = _this4.route.snapshot.paramMap.get('id');\n      if (!id || !_this4.selectedStock || !_this4.stockForm.qty) {\n        _this4.toastr.error('Please enter quantity');\n        return;\n      }\n      const token = _this4.authService.token;\n      if (!token) return;\n      try {\n        yield _this4.warehouseService.adjustStock({\n          productId: id,\n          warehouseId: _this4.selectedStock.warehouse?._id || _this4.selectedStock.warehouse,\n          qty: parseFloat(_this4.stockForm.qty),\n          locationId: _this4.stockForm.locationId || null\n        }).toPromise();\n        _this4.toastr.success('Stock adjusted successfully');\n        _this4.showAdjustStockModal = false;\n        _this4.selectedStock = null;\n        _this4.stockForm = {\n          warehouseId: '',\n          qty: '',\n          locationId: ''\n        };\n        yield _this4.refreshStock();\n      } catch (error) {\n        _this4.toastr.error(error?.message || 'Failed to adjust stock');\n      }\n    })();\n  }\n  openAdjustModal(stockItem) {\n    this.selectedStock = stockItem;\n    this.stockForm = {\n      warehouseId: stockItem.warehouse?._id || stockItem.warehouse,\n      qty: stockItem.qty || 0,\n      locationId: stockItem.location?._id || stockItem.location || ''\n    };\n    this.showAdjustStockModal = true;\n  }\n  get totalStock() {\n    return this.stock.reduce((sum, item) => sum + (item.qty || 0), 0);\n  }\n  get totalAvailable() {\n    return this.stock.reduce((sum, item) => sum + (item.availableQty || 0), 0);\n  }\n  get hasZeroStock() {\n    return this.totalStock === 0;\n  }\n  get hasLowStock() {\n    return this.totalStock > 0 && this.totalAvailable === 0;\n  }\n  formatCurrency(value) {\n    if (value === null || value === undefined || value === '') return '-';\n    const num = typeof value === 'number' ? value : parseFloat(value);\n    if (Number.isNaN(num)) return '-';\n    return `$${num.toFixed(2)}`;\n  }\n  formatLocation(location) {\n    if (!location) return '-';\n    const parts = [];\n    if (location.zone) parts.push(location.zone);\n    if (location.shelf) parts.push(location.shelf);\n    if (location.bin) parts.push(location.bin);\n    const result = parts.join('-');\n    return result || location.locationCode || '-';\n  }\n  generatePdf() {\n    var _this5 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this5.product?.id) return;\n      _this5.generatingPdf = true;\n      try {\n        const token = _this5.authService.token;\n        if (!token) {\n          _this5.toastr.error('Authentication required');\n          return;\n        }\n        const response = yield fetch(`${environment.apiUrl}/products/${_this5.product.id}/pdf/generate`, {\n          method: 'POST',\n          headers: {\n            'Authorization': `Bearer ${token}`,\n            'Content-Type': 'application/json'\n          }\n        });\n        if (response.ok) {\n          const blob = yield response.blob();\n          const url = window.URL.createObjectURL(blob);\n          const a = document.createElement('a');\n          a.href = url;\n          a.download = `product-${_this5.product.id}.pdf`;\n          document.body.appendChild(a);\n          a.click();\n          window.URL.revokeObjectURL(url);\n          document.body.removeChild(a);\n          _this5.toastr.success('PDF generated and downloaded successfully');\n          // Reload product to get updated PDF URL\n          yield _this5.loadProduct(_this5.product.id);\n        } else {\n          const error = yield response.json().catch(() => ({\n            message: 'Failed to generate PDF'\n          }));\n          _this5.toastr.error(error.message || 'Failed to generate PDF');\n        }\n      } catch (error) {\n        _this5.toastr.error(error?.message || 'Failed to generate PDF');\n      } finally {\n        _this5.generatingPdf = false;\n      }\n    })();\n  }\n  printLabel() {\n    if (!this.product?.barcode) {\n      this.toastr.error('Product must have a barcode to print label');\n      return;\n    }\n    // Get the print label container from the template\n    const printContainer = document.querySelector('.print-label-container');\n    if (!printContainer) {\n      this.toastr.error('Print container not found');\n      return;\n    }\n    // Make container visible but off-screen so Angular components can render\n    printContainer.style.cssText = `\n      display: block !important;\n      position: fixed !important;\n      left: -9999px !important;\n      top: 0 !important;\n      width: 100% !important;\n      height: 100% !important;\n      z-index: -1 !important;\n      background: white !important;\n      overflow: visible !important;\n      visibility: visible !important;\n    `;\n    // Force Angular change detection to render components\n    setTimeout(() => {\n      // Check for barcode elements - wait for them to render\n      const checkBarcodes = (attempts = 0) => {\n        const svg = printContainer.querySelector('svg');\n        const canvas = printContainer.querySelector('canvas');\n        if ((svg || canvas) && attempts < 20) {\n          // Barcodes are rendering, wait a bit more then print\n          setTimeout(() => {\n            // Mark as ready for print\n            printContainer.classList.add('print-ready');\n            // Trigger print\n            window.print();\n            // Clean up after printing\n            setTimeout(() => {\n              printContainer.classList.remove('print-ready');\n              printContainer.style.cssText = 'display: none !important; visibility: hidden !important; position: fixed !important; left: -9999px !important; top: -9999px !important;';\n            }, 500);\n          }, 500);\n        } else if (attempts < 20) {\n          // Keep checking\n          setTimeout(() => checkBarcodes(attempts + 1), 100);\n        } else {\n          // Timeout - try printing anyway\n          printContainer.classList.add('print-ready');\n          window.print();\n          setTimeout(() => {\n            printContainer.classList.remove('print-ready');\n            printContainer.style.cssText = 'display: none !important; visibility: hidden !important; position: fixed !important; left: -9999px !important; top: -9999px !important;';\n          }, 500);\n        }\n      };\n      checkBarcodes();\n    }, 100);\n  }\n};\nProductDetailComponent = __decorate([Component({\n  selector: 'app-product-detail',\n  templateUrl: './product-detail.component.html',\n  styleUrls: ['./product-detail.component.scss']\n}), __metadata(\"design:paramtypes\", [ActivatedRoute, Router, ProductsService, WarehouseService, AuthService, ApiService, ToastrService])], ProductDetailComponent);\nexport { ProductDetailComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}