{"ast":null,"code":"import _asyncToGenerator from \"F:/REACT PROJECT/IM/IM/InventoryManagement/frontend/node_modules/@angular-devkit/build-angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { Router } from '@angular/router';\nimport { ToastrService } from 'ngx-toastr';\nimport { ApiService } from '../../../core/services/api.service';\nimport { ProductsService } from '../../../core/services/products.service';\nimport { environment } from '../../../../environments/environment';\nimport { Html5Qrcode, Html5QrcodeSupportedFormats } from 'html5-qrcode';\nimport { WarehouseService } from '../../../core/services/warehouse.service';\nimport { CatalogService } from '../../../core/services/catalog.service';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../../../core/services/api.service\";\nimport * as i2 from \"../../../core/services/products.service\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"ngx-toastr\";\nimport * as i5 from \"../../../core/services/warehouse.service\";\nimport * as i6 from \"../../../core/services/catalog.service\";\nimport * as i7 from \"@angular/common\";\nimport * as i8 from \"@angular/forms\";\nimport * as i9 from \"../../../shared/components/spinner/spinner.component\";\nimport * as i10 from \"../../../shared/components/lucide-icon/lucide-icon.component\";\nfunction BarcodeScanComponent_button_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 11);\n    i0.ɵɵlistener(\"click\", function BarcodeScanComponent_button_9_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.clearScan());\n    });\n    i0.ɵɵelement(1, \"lucide-icon\", 12);\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BarcodeScanComponent_div_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 13);\n    i0.ɵɵelement(1, \"app-spinner\", 14);\n    i0.ɵɵelementStart(2, \"span\", 15);\n    i0.ɵɵtext(3, \"Searching for product...\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction BarcodeScanComponent_div_13_div_50_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"label\", 19);\n    i0.ɵɵtext(2, \"Description\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"p\", 21);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(ctx_r1.product.description);\n  }\n}\nfunction BarcodeScanComponent_div_13_div_51_button_3_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"button\", 28);\n    i0.ɵɵlistener(\"click\", function BarcodeScanComponent_div_13_div_51_button_3_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r1 = i0.ɵɵnextContext(3);\n      return i0.ɵɵresetView(ctx_r1.openPdf());\n    });\n    i0.ɵɵtext(1, \" Open PDF \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction BarcodeScanComponent_div_13_div_51_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 25)(1, \"button\", 26);\n    i0.ɵɵlistener(\"click\", function BarcodeScanComponent_div_13_div_51_Template_button_click_1_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r1 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r1.viewProductDetails());\n    });\n    i0.ɵɵtext(2, \" View Full Details \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(3, BarcodeScanComponent_div_13_div_51_button_3_Template, 2, 0, \"button\", 27);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngIf\", ctx_r1.product.pdfUrl);\n  }\n}\nfunction BarcodeScanComponent_div_13_div_52_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 29);\n    i0.ɵɵelement(1, \"app-spinner\", 30);\n    i0.ɵɵelementStart(2, \"p\", 31);\n    i0.ɵɵtext(3, \"Redirecting to PDF...\");\n    i0.ɵɵelementEnd()();\n  }\n}\nfunction BarcodeScanComponent_div_13_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 0)(1, \"div\", 16)(2, \"h2\", 17);\n    i0.ɵɵtext(3, \"Product Details\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"div\", 18)(5, \"div\")(6, \"label\", 19);\n    i0.ɵɵtext(7, \"Name\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(8, \"p\", 20);\n    i0.ɵɵtext(9);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(10, \"div\")(11, \"label\", 19);\n    i0.ɵɵtext(12, \"SKU\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(13, \"p\", 21);\n    i0.ɵɵtext(14);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(15, \"div\")(16, \"label\", 19);\n    i0.ɵɵtext(17, \"Barcode\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(18, \"p\", 21);\n    i0.ɵɵtext(19);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(20, \"div\")(21, \"label\", 19);\n    i0.ɵɵtext(22, \"Category\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(23, \"p\", 21);\n    i0.ɵɵtext(24);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(25, \"div\")(26, \"label\", 19);\n    i0.ɵɵtext(27, \"Brand\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(28, \"p\", 21);\n    i0.ɵɵtext(29);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(30, \"div\")(31, \"label\", 19);\n    i0.ɵɵtext(32, \"Variant\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(33, \"p\", 21);\n    i0.ɵɵtext(34);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(35, \"div\")(36, \"label\", 19);\n    i0.ɵɵtext(37, \"Price\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(38, \"p\", 21);\n    i0.ɵɵtext(39);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(40, \"div\")(41, \"label\", 19);\n    i0.ɵɵtext(42, \"Cost\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(43, \"p\", 21);\n    i0.ɵɵtext(44);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(45, \"div\")(46, \"label\", 19);\n    i0.ɵɵtext(47, \"Stock\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(48, \"p\", 21);\n    i0.ɵɵtext(49);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(50, BarcodeScanComponent_div_13_div_50_Template, 5, 1, \"div\", 22);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵtemplate(51, BarcodeScanComponent_div_13_div_51_Template, 4, 1, \"div\", 23)(52, BarcodeScanComponent_div_13_div_52_Template, 4, 0, \"div\", 24);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(9);\n    i0.ɵɵtextInterpolate(ctx_r1.product.name);\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate(ctx_r1.product.sku || \"-\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate(ctx_r1.product.barcode || ctx_r1.scannedBarcode);\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate((ctx_r1.product.category == null ? null : ctx_r1.product.category.name) || \"-\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate((ctx_r1.product.brand == null ? null : ctx_r1.product.brand.name) || \"-\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate((ctx_r1.product.variant == null ? null : ctx_r1.product.variant.name) || \"-\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\"$\", ctx_r1.product.price || \"0.00\", \"\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\"$\", ctx_r1.product.cost || \"0.00\", \"\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\"\", ctx_r1.product.quantity || 0, \" units\");\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r1.product.description);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r1.product && !ctx_r1.isRedirecting);\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngIf\", ctx_r1.isRedirecting);\n  }\n}\nfunction BarcodeScanComponent_div_14_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 32)(1, \"p\");\n    i0.ɵɵtext(2, \"No product found for barcode: \");\n    i0.ɵɵelementStart(3, \"strong\");\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"p\", 33);\n    i0.ɵɵtext(6, \"Make sure the barcode is correct and the product exists in the system.\");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(ctx_r1.scannedBarcode);\n  }\n}\nexport class BarcodeScanComponent {\n  constructor(api, productsService, router, toastr, warehouseService, catalogService) {\n    this.api = api;\n    this.productsService = productsService;\n    this.router = router;\n    this.toastr = toastr;\n    this.warehouseService = warehouseService;\n    this.catalogService = catalogService;\n    this.scannedBarcode = '';\n    this.product = null;\n    this.loading = false;\n    this.isMobile = false;\n    this.isRedirecting = false;\n    this.scanActive = false;\n    this.scanSuccess = false;\n    this.preventMultiple = false;\n    this.availableCameras = [];\n    this.cameraId = '';\n    this.transferType = 'warehouse';\n    this.warehouses = [];\n    this.stores = [];\n    this.selectedDestinationId = '';\n  }\n  ngOnInit() {\n    // Detect mobile device\n    this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\n    this.prepareScanner();\n  }\n  ngOnDestroy() {\n    if (this.inputTimeout) {\n      clearTimeout(this.inputTimeout);\n    }\n    this.stopScanning();\n  }\n  onBarcodeInput(value) {\n    this.scannedBarcode = value;\n    // Clear previous timeout\n    if (this.inputTimeout) {\n      clearTimeout(this.inputTimeout);\n    }\n    // Wait for user to finish typing (debounce)\n    this.inputTimeout = setTimeout(() => {\n      if (value && value.trim().length > 0) {\n        this.scanBarcode(value.trim());\n      }\n    }, 500);\n  }\n  prepareScanner() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      try {\n        const cams = yield Html5Qrcode.getCameras();\n        _this.availableCameras = cams || [];\n        _this.cameraId = _this.availableCameras[0]?.id || '';\n      } catch {}\n    })();\n  }\n  startScanning() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      if (_this2.scanActive) return;\n      _this2.scanSuccess = false;\n      _this2.preventMultiple = false;\n      try {\n        _this2.html5Qr = new Html5Qrcode('qr-reader', {\n          verbose: false\n        });\n        const config = {\n          fps: 10,\n          qrbox: {\n            width: 250,\n            height: 250\n          },\n          formatsToSupport: [Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.QR_CODE]\n        };\n        _this2.scanActive = true;\n        yield _this2.html5Qr.start(_this2.cameraId ? _this2.cameraId : {\n          facingMode: 'environment'\n        }, config, decodedText => {\n          if (_this2.preventMultiple) return;\n          _this2.preventMultiple = true;\n          _this2.scanSuccess = true;\n          _this2.scannedBarcode = decodedText;\n          _this2.stopScanning();\n          _this2.loadWarehousesAndStores();\n          _this2.scanBarcode(decodedText);\n          _this2.router.navigate(['/products'], {\n            queryParams: {\n              sku: decodedText\n            }\n          });\n        }, () => {});\n      } catch (err) {\n        _this2.scanActive = false;\n        _this2.toastr.error(err?.message || 'Unable to start camera');\n      }\n    })();\n  }\n  stopScanning() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      try {\n        if (_this3.html5Qr && _this3.scanActive) {\n          yield _this3.html5Qr.stop();\n          yield _this3.html5Qr.clear();\n        }\n      } catch {}\n      _this3.scanActive = false;\n    })();\n  }\n  changeCamera(id) {\n    this.cameraId = id;\n    if (this.scanActive) {\n      this.stopScanning().then(() => this.startScanning());\n    }\n  }\n  scanBarcode(barcode) {\n    if (!barcode) {\n      this.toastr.error('Please enter or scan a barcode');\n      return;\n    }\n    // Check if the scanned value is already a PDF URL (from QR code)\n    if (barcode.startsWith('http://') || barcode.startsWith('https://')) {\n      // Direct PDF URL - redirect immediately\n      window.location.href = barcode;\n      return;\n    }\n    this.loading = true;\n    this.product = null;\n    // Call API to find product by barcode\n    this.api.get(`/barcodes/scan?barcode=${encodeURIComponent(barcode)}`).subscribe({\n      next: res => {\n        this.loading = false;\n        if (res.success && res.data) {\n          this.product = res.data;\n          // Always redirect to PDF if available (both mobile and desktop)\n          if (this.product.pdfUrl) {\n            this.isRedirecting = true;\n            // Build full URL for PDF using API base URL\n            const apiBaseUrl = environment.apiUrl.replace('/api', ''); // Remove /api since pdfUrl already includes it\n            const pdfUrl = this.product.pdfUrl.startsWith('http') ? this.product.pdfUrl : `${apiBaseUrl}${this.product.pdfUrl}`;\n            // Small delay to show redirect message, then redirect\n            setTimeout(() => {\n              window.location.href = pdfUrl;\n            }, 500);\n          } else {\n            // Fallback: show product details\n            this.toastr.info('PDF not available. Showing product details.');\n          }\n        } else {\n          this.toastr.error('Product not found for this barcode');\n        }\n      },\n      error: err => {\n        this.loading = false;\n        const errorMsg = err?.error?.message || 'Failed to scan barcode';\n        this.toastr.error(errorMsg);\n        this.product = null;\n      }\n    });\n  }\n  redirectToProductPdf(productId) {\n    // Fallback to product detail page\n    this.router.navigate(['/products', productId]);\n  }\n  openPdf() {\n    if (this.product?.pdfUrl) {\n      const apiBaseUrl = environment.apiUrl.replace('/api', ''); // Remove /api since pdfUrl already includes it\n      const pdfUrl = this.product.pdfUrl.startsWith('http') ? this.product.pdfUrl : `${apiBaseUrl}${this.product.pdfUrl}`;\n      window.open(pdfUrl, '_blank');\n    }\n  }\n  viewProductDetails() {\n    if (this.product?.id) {\n      this.router.navigate(['/products', this.product.id]);\n    }\n  }\n  clearScan() {\n    this.scannedBarcode = '';\n    this.product = null;\n    this.scanSuccess = false;\n  }\n  loadWarehousesAndStores() {\n    this.warehouseService.list({\n      limit: 1000\n    }).subscribe({\n      next: res => {\n        this.warehouses = res.warehouses || [];\n      },\n      error: () => {}\n    });\n    this.catalogService.listStores().subscribe({\n      next: stores => {\n        this.stores = stores || [];\n      },\n      error: () => {}\n    });\n  }\n  confirmTransfer() {\n    if (!this.scannedBarcode || !this.selectedDestinationId) {\n      this.toastr.error('Select destination');\n      return;\n    }\n    this.router.navigate(['/stock/transfer'], {\n      queryParams: {\n        sku: this.scannedBarcode,\n        type: this.transferType,\n        dest: this.selectedDestinationId\n      }\n    });\n  }\n  static {\n    this.ɵfac = function BarcodeScanComponent_Factory(t) {\n      return new (t || BarcodeScanComponent)(i0.ɵɵdirectiveInject(i1.ApiService), i0.ɵɵdirectiveInject(i2.ProductsService), i0.ɵɵdirectiveInject(i3.Router), i0.ɵɵdirectiveInject(i4.ToastrService), i0.ɵɵdirectiveInject(i5.WarehouseService), i0.ɵɵdirectiveInject(i6.CatalogService));\n    };\n  }\n  static {\n    this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: BarcodeScanComponent,\n      selectors: [[\"app-barcode-scan\"]],\n      decls: 15,\n      vars: 5,\n      consts: [[1, \"space-y-4\"], [1, \"page-title\"], [1, \"card\", \"p-4\", \"space-y-4\"], [1, \"label\"], [1, \"flex\", \"gap-2\"], [\"type\", \"text\", \"placeholder\", \"Scan barcode or enter manually\", \"autofocus\", \"\", 1, \"input\", \"flex-1\", 3, \"ngModelChange\", \"input\", \"ngModel\"], [\"class\", \"btn btn-secondary\", \"type\", \"button\", 3, \"click\", 4, \"ngIf\"], [1, \"text-sm\", \"text-gray-500\", \"mt-1\"], [\"class\", \"flex items-center justify-center py-8\", 4, \"ngIf\"], [\"class\", \"space-y-4\", 4, \"ngIf\"], [\"class\", \"text-center py-8 text-gray-500\", 4, \"ngIf\"], [\"type\", \"button\", 1, \"btn\", \"btn-secondary\", 3, \"click\"], [\"name\", \"x\", 1, \"h-4\", \"w-4\"], [1, \"flex\", \"items-center\", \"justify-center\", \"py-8\"], [1, \"h-8\", \"w-8\"], [1, \"ml-2\", \"text-gray-600\"], [1, \"border-t\", \"pt-4\"], [1, \"text-lg\", \"font-semibold\", \"mb-4\"], [1, \"grid\", \"grid-cols-1\", \"md:grid-cols-2\", \"gap-4\"], [1, \"text-sm\", \"font-medium\", \"text-gray-700\"], [1, \"text-gray-900\", \"font-semibold\"], [1, \"text-gray-900\"], [4, \"ngIf\"], [\"class\", \"flex gap-2 pt-4 border-t\", 4, \"ngIf\"], [\"class\", \"text-center py-4\", 4, \"ngIf\"], [1, \"flex\", \"gap-2\", \"pt-4\", \"border-t\"], [1, \"btn\", \"btn-primary\", 3, \"click\"], [\"class\", \"btn btn-secondary\", 3, \"click\", 4, \"ngIf\"], [1, \"btn\", \"btn-secondary\", 3, \"click\"], [1, \"text-center\", \"py-4\"], [1, \"h-6\", \"w-6\", \"mx-auto\"], [1, \"text-sm\", \"text-gray-600\", \"mt-2\"], [1, \"text-center\", \"py-8\", \"text-gray-500\"], [1, \"text-sm\", \"mt-2\"]],\n      template: function BarcodeScanComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵelementStart(0, \"div\", 0)(1, \"h1\", 1);\n          i0.ɵɵtext(2, \"Scan Barcode\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(3, \"div\", 2)(4, \"div\")(5, \"label\", 3);\n          i0.ɵɵtext(6, \"Scan or Enter Barcode (Code 128 or QR Code)\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(7, \"div\", 4)(8, \"input\", 5);\n          i0.ɵɵtwoWayListener(\"ngModelChange\", function BarcodeScanComponent_Template_input_ngModelChange_8_listener($event) {\n            i0.ɵɵtwoWayBindingSet(ctx.scannedBarcode, $event) || (ctx.scannedBarcode = $event);\n            return $event;\n          });\n          i0.ɵɵlistener(\"input\", function BarcodeScanComponent_Template_input_input_8_listener($event) {\n            return ctx.onBarcodeInput($event.target.value);\n          });\n          i0.ɵɵelementEnd();\n          i0.ɵɵtemplate(9, BarcodeScanComponent_button_9_Template, 2, 0, \"button\", 6);\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(10, \"p\", 7);\n          i0.ɵɵtext(11, \"Supported formats: Code 128, QR Code\");\n          i0.ɵɵelementEnd()();\n          i0.ɵɵtemplate(12, BarcodeScanComponent_div_12_Template, 4, 0, \"div\", 8)(13, BarcodeScanComponent_div_13_Template, 53, 12, \"div\", 9)(14, BarcodeScanComponent_div_14_Template, 7, 1, \"div\", 10);\n          i0.ɵɵelementEnd()();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance(8);\n          i0.ɵɵtwoWayProperty(\"ngModel\", ctx.scannedBarcode);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.scannedBarcode);\n          i0.ɵɵadvance(3);\n          i0.ɵɵproperty(\"ngIf\", ctx.loading);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.product && !ctx.loading);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", !ctx.product && !ctx.loading && ctx.scannedBarcode);\n        }\n      },\n      dependencies: [i7.NgIf, i8.DefaultValueAccessor, i8.NgControlStatus, i8.NgModel, i9.SpinnerComponent, i10.LucideIconComponent]\n    });\n  }\n}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}