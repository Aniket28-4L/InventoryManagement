{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nimport { Component } from '@angular/core';\nimport { FormBuilder, Validators } from '@angular/forms';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { ToastrService } from 'ngx-toastr';\nimport { SuppliersService } from '../../../core/services/suppliers.service';\nimport { ProductsService } from '../../../core/services/products.service';\nlet SupplierFormComponent = class SupplierFormComponent {\n  get isEditMode() {\n    return !!this.supplierId;\n  }\n  constructor(fb, suppliersService, productsService, route, router, toastr) {\n    this.fb = fb;\n    this.suppliersService = suppliersService;\n    this.productsService = productsService;\n    this.route = route;\n    this.router = router;\n    this.toastr = toastr;\n    this.form = this.fb.group({\n      name: ['', Validators.required],\n      companyName: ['', Validators.required],\n      contactName: [''],\n      email: ['', [Validators.email]],\n      phone: [''],\n      address: [''],\n      city: [''],\n      state: [''],\n      zipCode: [''],\n      country: [''],\n      website: [''],\n      notes: [''],\n      products: [[]]\n    });\n    this.loading = true;\n    this.saving = false;\n    this.supplierId = null;\n    this.products = [];\n    this.selectedProducts = [];\n    this.productsLoading = false;\n  }\n  ngOnInit() {\n    this.supplierId = this.route.snapshot.paramMap.get('id');\n    this.loadProducts();\n    if (this.supplierId) {\n      this.loadSupplier(this.supplierId);\n    } else {\n      this.loading = false;\n    }\n  }\n  loadProducts() {\n    this.productsLoading = true;\n    this.productsService.list({\n      limit: 1000\n    }).subscribe({\n      next: res => {\n        this.products = res.products || [];\n        this.productsLoading = false;\n      },\n      error: err => {\n        console.error('Failed to load products:', err);\n        this.productsLoading = false;\n        this.toastr.warning('Failed to load products list');\n      }\n    });\n  }\n  loadSupplier(id) {\n    this.loading = true;\n    this.suppliersService.get(id).subscribe({\n      next: supplier => {\n        const address = supplier.address || {};\n        const addressObj = typeof address === 'string' ? {} : address;\n        const supplierProducts = supplier.products || [];\n        const productIds = supplierProducts.map(p => p.product?.id || p.product?._id || p.product).filter(Boolean);\n        this.form.patchValue({\n          name: supplier.name || '',\n          companyName: supplier.companyName || '',\n          contactName: supplier.contact?.person || '',\n          email: supplier.contact?.email || '',\n          phone: supplier.contact?.phone || '',\n          address: typeof address === 'string' ? address : addressObj['street'] || addressObj['address'] || '',\n          city: addressObj['city'] || '',\n          state: addressObj['state'] || '',\n          zipCode: addressObj['postalCode'] || addressObj['zipCode'] || addressObj['zip'] || '',\n          country: addressObj['country'] || '',\n          website: supplier.business?.['website'] || '',\n          notes: supplier.notes || '',\n          products: productIds\n        });\n        this.selectedProducts = this.products.filter(p => productIds.includes(p.id));\n        this.loading = false;\n      },\n      error: () => {\n        this.toastr.error('Failed to load supplier');\n        this.loading = false;\n        this.router.navigate(['/suppliers']);\n      }\n    });\n  }\n  onProductSelect(product) {\n    const productIds = this.form.value.products || [];\n    if (productIds.includes(product.id)) {\n      this.selectedProducts = this.selectedProducts.filter(p => p.id !== product.id);\n      this.form.patchValue({\n        products: productIds.filter(id => id !== product.id)\n      });\n    } else {\n      this.selectedProducts.push(product);\n      this.form.patchValue({\n        products: [...productIds, product.id]\n      });\n    }\n  }\n  removeProduct(productId) {\n    this.selectedProducts = this.selectedProducts.filter(p => p.id !== productId);\n    const productIds = (this.form.value.products || []).filter(id => id !== productId);\n    this.form.patchValue({\n      products: productIds\n    });\n  }\n  onSubmit() {\n    if (this.form.invalid || this.saving) {\n      if (this.form.invalid) {\n        this.toastr.error('Please fill in all required fields');\n      }\n      return;\n    }\n    this.saving = true;\n    const formValue = this.form.value;\n    const payload = {\n      name: formValue.name || '',\n      companyName: formValue.companyName || '',\n      contact: {\n        person: formValue.contactName || undefined,\n        email: formValue.email || undefined,\n        phone: formValue.phone || undefined\n      },\n      address: {\n        street: formValue.address || undefined,\n        city: formValue.city || undefined,\n        state: formValue.state || undefined,\n        postalCode: formValue.zipCode || undefined,\n        country: formValue.country || undefined\n      },\n      business: {\n        website: formValue.website || undefined\n      },\n      notes: formValue.notes || undefined\n    };\n    // Add products if selected\n    const productIds = formValue.products || [];\n    if (productIds.length > 0) {\n      payload.products = productIds.map(productId => ({\n        product: productId\n      }));\n    }\n    // Remove undefined values to avoid sending null\n    Object.keys(payload).forEach(key => {\n      if (payload[key] === undefined) delete payload[key];\n      if (typeof payload[key] === 'object' && payload[key] !== null && !Array.isArray(payload[key])) {\n        Object.keys(payload[key]).forEach(subKey => {\n          if (payload[key][subKey] === undefined) delete payload[key][subKey];\n        });\n        if (Object.keys(payload[key]).length === 0) delete payload[key];\n      }\n    });\n    console.log('Submitting supplier payload:', payload);\n    const operation = this.isEditMode ? this.suppliersService.update(this.supplierId, payload) : this.suppliersService.create(payload);\n    operation.subscribe({\n      next: () => {\n        this.toastr.success(`Supplier ${this.isEditMode ? 'updated' : 'created'} successfully`);\n        this.router.navigate(['/suppliers']);\n      },\n      error: error => {\n        console.error('Supplier create/update error:', error);\n        let errorMessage = `Failed to ${this.isEditMode ? 'update' : 'create'} supplier`;\n        if (error?.error) {\n          if (error.error.errors && Array.isArray(error.error.errors)) {\n            const validationErrors = error.error.errors.map(e => e.msg || e.message || e).join(', ');\n            errorMessage = `Validation failed: ${validationErrors}`;\n          } else if (error.error.message) {\n            errorMessage = error.error.message;\n          }\n        } else if (error?.message) {\n          errorMessage = error.message;\n        }\n        this.toastr.error(errorMessage);\n        this.saving = false;\n      }\n    });\n  }\n};\nSupplierFormComponent = __decorate([Component({\n  selector: 'app-supplier-form',\n  templateUrl: './supplier-form.component.html',\n  styleUrls: ['./supplier-form.component.scss']\n}), __metadata(\"design:paramtypes\", [FormBuilder, SuppliersService, ProductsService, ActivatedRoute, Router, ToastrService])], SupplierFormComponent);\nexport { SupplierFormComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}