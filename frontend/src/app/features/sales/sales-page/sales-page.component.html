<div class="space-y-4">
  <h1 class="page-title">Sales</h1>

  <div class="card p-4">
    <div class="flex gap-2 items-center mb-3">
      <input [(ngModel)]="searchTerm" (input)="onSearchInput($any($event.target).value)" (keyup.enter)="search()" placeholder="Search products" class="input w-full" />
      <button class="btn btn-secondary" (click)="search()">Search</button>
    </div>
    <div *ngIf="loadingProducts" class="py-4 text-center"><app-spinner class="h-6 w-6 mx-auto"></app-spinner></div>
    <div *ngIf="!loadingProducts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
      <div *ngFor="let p of filteredProducts()" class="border rounded p-3">
        <div class="font-medium">{{ p.name }}</div>
        <div class="text-sm text-gray-600">SKU: {{ p.sku }}</div>
        <div class="text-sm">Price: {{ p.price?.toFixed(2) || '0.00' }}</div>
        <button class="btn btn-primary mt-2" (click)="addToCart(p)">Add</button>
      </div>
    </div>
  </div>

  <div class="card p-4" *ngIf="cart.length > 0">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="border-b">
            <th class="text-left py-2 px-3 text-sm font-medium text-gray-700">Product</th>
            <th class="text-right py-2 px-3 text-sm font-medium text-gray-700">Quantity</th>
            <th class="text-right py-2 px-3 text-sm font-medium text-gray-700">Unit Price</th>
            <th class="text-right py-2 px-3 text-sm font-medium text-gray-700">Discount</th>
            <th class="text-right py-2 px-3 text-sm font-medium text-gray-700">Line Total</th>
            <th class="text-center py-2 px-3 text-sm font-medium text-gray-700">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of cart; let i = index" class="border-b">
            <td class="py-2 px-3">
              <div class="font-medium">
                {{ item.product.name }}
                <span *ngIf="item.variantValue" class="text-gray-600 font-normal">({{ item.variantValue }})</span>
              </div>
              <div *ngIf="item.availableVariants && item.availableVariants.length > 0" class="mt-1">
                <select class="input py-1 px-2 text-sm" [value]="item.variantValue" (change)="updateVariantValue(item, $any($event.target).value)">
                  <option value="">Select Variant</option>
                  <option *ngFor="let v of item.availableVariants" [value]="v">{{ v }}</option>
                </select>
              </div>
            </td>
            <td class="py-2 px-3 text-right">
              <input type="number" min="1" class="input w-24 text-right" [value]="item.quantity" (input)="updateQuantity(item, $any($event.target).value)" />
            </td>
            <td class="py-2 px-3 text-right">{{ item.product.price?.toFixed(2) || '0.00' }}</td>
            <td class="py-2 px-3 text-right">
              <input type="number" min="0" class="input w-24 text-right" [value]="item.discount" (input)="updateDiscount(item, $any($event.target).value)" />
            </td>
            <td class="py-2 px-3 text-right">{{ lineTotal(item).toFixed(2) }}</td>
            <td class="py-2 px-3 text-center">
              <div class="flex items-center justify-center gap-2">
                <button class="btn btn-sm btn-primary" (click)="addVariantRow(item)" [title]="'Add another variant of ' + item.product.name">
                  <lucide-icon name="plus" class="h-4 w-4"></lucide-icon>
                </button>
                <button class="btn btn-secondary" (click)="removeFromCart(i)">Remove</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="flex justify-end items-center gap-4 mt-4">
      <div class="text-lg font-semibold">Grand Total: KD {{ grandTotal().toFixed(2) }}</div>
      <div class="flex flex-col">
        <label for="buyerName" class="text-sm font-medium text-gray-700 mb-1">Buyer Name (Optional)</label>
        <input id="buyerName" [(ngModel)]="buyerName" placeholder="Enter buyer name" class="input w-64 border-gray-300 focus:border-blue-500 focus:ring-blue-500" />
      </div>
      <button class="btn btn-primary h-10 self-end" [disabled]="submitting" (click)="generateInvoice()">Generate Invoice</button>
    </div>
  </div>
</div>